---
import type { StoreProduct } from "@medusajs/types";
import Layout from "../../../layouts/Layout.astro";
import { medusa } from "../../../lib/medusa";
import ProductShell from "../../../modules/product/components/ProductShell";

export async function getStaticPaths() {
	let products: StoreProduct[] = [];
	try {
		const res = await medusa.store.product.list({
			fields:
				"*variants.calculated_price,+variants.inventory_quantity,+metadata,+tags,+product_description.*",
		});
		products = res.products;
	} catch (e) {
		console.error("Failed to fetch products for paths", e);
	}

	return products.map((product) => ({
		params: { slug: product.handle },
		props: { product },
	}));
}

const { product } = Astro.props;

let productPageData = null;
try {
	const strapiUrl = import.meta.env.STRAPI_URL || "http://localhost:1337";
	const strapiToken = import.meta.env.STRAPI_TOKEN;
	const headers: HeadersInit = {
		"Content-Type": "application/json",
	};
	if (strapiToken) {
		headers.Authorization = `Bearer ${strapiToken}`;
	}

	// Use deep populate for dynamic zones (aplusContent)
	const populateQuery = encodeURIComponent(
		JSON.stringify({
			trustBadges: { populate: "*" },
			aplusContent: {
				on: {
					"aplus.a-plus-hero": { populate: "*" },
					"aplus.a-plus-feature-grid": {
						populate: { features: { populate: "*" } },
					},
					"aplus.a-plus-comparison-chart": {
						populate: {
							products: { populate: "*" },
							features: { populate: "*" },
						},
					},
					"aplus.a-plus-image-text": { populate: "*" },
					"aplus.a-plus-video": { populate: "*" },
					"aplus.a-plus-brand-story": {
						populate: {
							logo: { populate: "*" },
							slides: { populate: "*" },
						},
					},
				},
			},
		}),
	);

	const res = await fetch(
		`${strapiUrl}/api/product-page?populate=${populateQuery}`,
		{
			headers,
		},
	);
	const data = await res.json();
	if (data?.data) {
		const attrs = data.data.attributes || data.data; // Handle v4/v5 structure
		productPageData = {
			...attrs,
			strapiUrl, // Pass strapiUrl to components for image resolution
		};
	}
} catch (e) {
	console.error("Failed to fetch product-page content", e);
}
---

<Layout title={`${product.title} - Tiny Explorer`}>
	<div class="py-12 bg-white">
		<ProductShell
			client:load
			product={product}
			staticContent={productPageData}
		/>
	</div>
</Layout>
